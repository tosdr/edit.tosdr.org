version: '3.9'
services:
  db:
    image: postgres:14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_DB=phoenix_development
      - POSTGRES_PASSWORD=""
      - POSTGRES_HOST_AUTH_METHOD=trust
    container_name: db
    hostname: db 
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - '5432:5432'
    healthcheck:
        test: ["CMD", "pg_isready", "-U", "postgres"]
        interval: 1s
    volumes:
      # Will use db volume and inside to path /var/lib/mysql
      - ./tmp/db/postgresql/data:/var/lib/postgresql/data
    networks:
      - dbs
  elasticsearch:
    image: hypothesis/elasticsearch:latest
    ports:
      - '127.0.0.1:9200:9200'
    environment:
      - discovery.type=single-node
    networks:
      - elasticsearch
  ota:
    image: pondersource/tosdr-ota:1.3
    ports:
      - '127.0.0.1:3000:3000'
    networks:
      - dbs
    environment:
      - API_SECRET=foo
    cap_add: [ SYS_ADMIN ]
  web:
    tty: true
    stdin_open: true
    build:
      context: ./
      dockerfile: Dockerfile
      target: dev
    ports:
      - 9090:3000
    depends_on:
      - db
    volumes:
      - ./app:/usr/src/edit.tosdr.org/app/
      - ./lib:/usr/src/edit.tosdr.org/lib/
      - ./db:/usr/src/edit.tosdr.org/db/
      - ./config:/usr/src/edit.tosdr.org/config/
      - ./spec:/usr/src/edit.tosdr.org/spec/
    networks:
      - dbs
      - elasticsearch
    environment:
      - RAILS_ENV=development
      - DATABASE_HOST=db
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=""
      - DATABASE_NAME=phoenix_development
      - H_ORIGIN=http://localhost:5000
      - WEB_PORT=9090
      - ELASTICSEARCH_HOST=elasticsearch
      - AUTHORITY=localhost
      - OTA_URL=http://ota:3000
      - OTA_API_SECRET=foo
  # Useful during development: inspect the database at localhost:1337
  adminer:
    image: adminer
    ports:
      - 1337:8080
    environment:
      - RAILS_ENV=development

volumes:
  # Create volume called web for persistent storage
  web:
    # Specify name so it does not append stack name
    name: web
  # db_postgres14:
  #   name: db_postgres14
networks:
  dbs:
    # Joins existing network of this name (it was created by db container)
    external: true
    # Specify name so that it does not append stack name
    name: dbs
  elasticsearch:
    external: true
    name: elasticsearch
  engine:
    external: true
    name: engine
